<?php

/*
 * wordpress_vulnerability_admarketlocation.php
 */

class wordpress_vulnerability_admarketlocation_class extends wordpress_vulnerability_base_class
{
	private $infected;

	function Check($options, &$vulnerable)
	{
		if(IsSet($this->infected))
		{
			$vulnerable = count($this->infected) > 0;
			return true;
		}
		if(!$this->wordpress_vulnerabilities->GetAllQueryResults('SHOW TABLES', $tables))
			return false;
		foreach($tables as $table)
		{
			$name = $table[0];
			if(preg_match('/^wp_([0-9]+_)?options$/', $name))
			{
				$infected_properties = array();
				$infected = array(
					'table'=>$name,
				);
				if(!$this->wordpress_vulnerabilities->GetAllQueryResults('SELECT * FROM '.$name, $properties))
					return false;
				$transient = '_transient';
				$tp = count($properties);
				for($p = 0; $p < $tp; ++$p)
				{
					$property = $properties[$p][1];
					if(substr($property, 0, strlen($transient)) === $transient)
						continue;
					$value = $properties[$p][2];
					switch($property)
					{
						case 'blogname':
							$infected[$property] = $value;
							break;
					}
					if(stripos($value, 'admarketlocation.com') !== false)
					{
						$infected_properties[] = array(
							'id'=>$properties[$p][0],
							'property'=>$property,
							'value'=>$value,
						);
					}
				}
				if(count($infected_properties))
				{
					$infected['properties'] = $infected_properties;
					$this->infected[] = $infected;
				}
			}
		}
		$vulnerable = count($this->infected) > 0;
		return true;
	}

	function Fix($options, &$plan)
	{
		if(!$this->Check($options, $vulnerable))
			return false;
		if(!$vulnerable)
			return true;
		foreach($this->infected as $infected_properties)
		{
			$blog_name = $infected_properties['blogname'];
			if(!IsSet($options['FixURL'][$blog_name]))
				return $this->SetError('it was not specified the FixURL vulnerability option for blog "'.$blog_name.'"');
			foreach($infected_properties['properties'] as $property)
			{
				$plan[] = array(
					'Type'=>'update_query',
					'Details'=>array(
						'Table'=>$infected_properties['table'],
						'Fields'=>array(
							'option_value'=>$options['FixURL'][$blog_name]
						),
						'Conditions'=>array(
							array(
								'Type'=>'equal',
								'Details'=>array(
									'LeftField'=>'option_id',
									'RightValue'=>intval($property['id']),
								)
							),
						)
					)
				);
			}
			
		}
		return true;
	}
};